<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 BLE Joystick + 4 Servos</title>
  <style>
    :root{
      --bg:#1a2430;
      --card:#0b1220;
      --panel:#111827;
      --accent:#0ea5e9;
      --muted:#94a3b8;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
    }
    html,body{
      height:100%;margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background:linear-gradient(180deg,var(--bg),#192735);
      color:#e6eef6;
    }

    .app {
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:20px;
      max-width:1150px;
      margin:18px auto;
      padding:16px;
    }

    @media (max-width:900px){
      .app{grid-template-columns:1fr; padding:12px;}
      .side { order: 2; }
      .main { order: 1; }
      .sliders { flex-direction:row; gap:10px; justify-content:center; flex-wrap:wrap; }
      .servoCard { width:90%; }
      input[type="range"]{ width:90vw; }
      #joystick { width:260px; height:260px; }
    }

    .card{
      background: linear-gradient(180deg,var(--card),#08131f);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.04);
    }

    .main { display:flex; flex-direction:column; gap:16px; min-height:380px; }
    h2{margin:0 0 6px 0;font-size:18px;color:var(--accent)}
    .statusRow{display:flex;align-items:center;gap:12px;justify-content:space-between}
    #status{
      font-size:13px;padding:8px 10px;border-radius:10px;background:var(--glass);color:var(--muted);
      display:inline-block; min-width:220px;
    }
    #connectBtn{
      background:var(--accent); color:#021026; border:none; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;
      box-shadow: 0 6px 12px rgba(14,165,233,0.12);
    }

    .controller {
      display:flex; gap:18px; align-items:center; justify-content:center; padding:8px; flex-wrap:wrap;
    }

    #joystick {
      width:320px; height:320px; border-radius:50%;
      background: radial-gradient(circle at 50% 45%, #0b1320 0%, #071018 80%);
      position:relative; display:flex;align-items:center;justify-content:center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5), inset 0 -8px 24px rgba(255,255,255,0.04);
      touch-action: none;
      border: 2px solid rgba(255,255,255,0.08);
    }
    .gridRings{
      position:absolute; inset:0; border-radius:50%; pointer-events:none;
      background:
        radial-gradient(circle at center, rgba(255,255,255,0.05) 0, rgba(255,255,255,0.0) 60%),
        radial-gradient(circle, rgba(255,255,255,0.02) 1px, transparent 1px);
      opacity:0.7;
    }
    #stick{
      width:96px;height:96px;border-radius:50%;
      background:linear-gradient(180deg,var(--accent),#0369a1);
      box-shadow: 0 6px 18px rgba(10,140,200,0.24), 0 2px 6px rgba(0,0,0,0.6);
      position:absolute; transform:translate(-50%,-50%); left:50%; top:50%;
      touch-action: none;
      transition: left 0.02s linear, top 0.02s linear;
    }

    #rotationButtons{display:flex;flex-direction:column;gap:12px;align-items:center}
    .rotBtn{
      width:86px;height:86px;border-radius:50%; border:none;
      font-size:30px; display:flex;align-items:center;justify-content:center;
      background:#0b1622;color:var(--accent);
      box-shadow:0 8px 18px rgba(0,0,0,0.6);
      cursor:pointer; user-select:none;
      touch-action: manipulation;
    }
    .rotBtn.pressed{ transform: translateY(2px); opacity:0.9; filter:brightness(1.05); }

    .side { width:100%; max-width:380px; }
    .sliders{ display:flex; flex-direction:column; gap:16px; margin-top:10px; }
    .servoCard{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px; border-radius:12px;
      background:linear-gradient(180deg,#08141c,#061018);
      box-shadow:inset 0 0 4px rgba(255,255,255,0.02);
    }
    .servoLabel{ font-size:14px; color:var(--muted); width:72px; }
    .servoControl{ display:flex; gap:10px; align-items:center; width:100%; }
    input[type="range"]{
      -webkit-appearance:none; appearance:none;
      height:40px; width:100%;
      background:transparent; touch-action:none;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height:10px; border-radius:20px;
      background: linear-gradient(90deg,#0d1828,#0e3b5e);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:38px; height:38px; border-radius:50%; margin-top:-14px;
      background:linear-gradient(180deg,var(--accent),#0369a1);
      box-shadow:0 6px 16px rgba(10,140,200,0.25);
    }
    .servoValue{ width:48px; text-align:center; font-weight:700; color:#e6eef6; font-size:15px; }

    .hint{ font-size:12px;color:var(--muted); margin-top:6px }
  </style>
</head>
<body>
  <div class="app">
    <div class="main card">
      <h2>ESP32 BLE Joystick Controller</h2>
      <div class="statusRow">
        <div id="status">未接続</div>
        <div>
          <button id="connectBtn">接続</button>
          <button id="reconnectBtn" style="margin-left:8px;padding:8px 10px;border-radius:8px;background:#0b1220;border:1px solid rgba(255,255,255,0.04);color:var(--muted);cursor:pointer;">再接続</button>
        </div>
      </div>

      <div class="controller">
        <div id="joystick" aria-label="joystick">
          <div class="gridRings"></div>
          <div id="stick" role="application" aria-label="stick"></div>
        </div>

        <div id="rotationButtons">
          <button id="leftRotate" class="rotBtn" aria-label="rotate left">⟲</button>
          <button id="rightRotate" class="rotBtn" aria-label="rotate right">⟳</button>
        </div>
      </div>

      <!-- ここに新しいモータ用スライダーを追加（ジョイスティック＋回転ボタンの下、サーボ群の上） -->
      <div class="servoCard" style="margin-top:10px;">
        <div class="servoLabel">Motor</div>
        <div class="servoControl">
          <!-- -1.00 (left) 〜 0 (center) 〜 1.00 (right) -->
          <input id="motorSlider" type="range" min="-1" max="1" step="0.01" value="0" />
          <div class="servoValue" id="motorVal">0.00</div>
        </div>
      </div>

      <div class="hint">※ スティックは指で押してドラッグ、指を離すと中心に戻ります。回転は押している間だけ回転コマンド。</div>
    </div>

    <div class="side card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:700">Servo Controls</div>
        <div style="font-size:13px;color:var(--muted)">0〜180°</div>
      </div>

      <div class="sliders">
        <div class="servoCard">
          <div class="servoLabel">Servo 1</div>
          <div class="servoControl">
            <input id="s1" type="range" min="0" max="180" value="90" />
            <div class="servoValue" id="s1val">90</div>
          </div>
        </div>

        <div class="servoCard">
          <div class="servoLabel">Servo 2</div>
          <div class="servoControl">
            <input id="s2" type="range" min="0" max="180" value="90" />
            <div class="servoValue" id="s2val">90</div>
          </div>
        </div>

        <div class="servoCard">
          <div class="servoLabel">Servo 3</div>
          <div class="servoControl">
            <input id="s3" type="range" min="0" max="180" value="90" />
            <div class="servoValue" id="s3val">90</div>
          </div>
        </div>

        <div class="servoCard">
          <div class="servoLabel">Servo 4</div>
          <div class="servoControl">
            <input id="s4" type="range" min="0" max="180" value="90" />
            <div class="servoValue" id="s4val">90</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* -------------------------
   Configuration / UUIDs
   ------------------------- */
const SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0";
const CHARACTERISTIC_UUID = "abcd1234-1234-5678-1234-56789abcdef0";
const DEVICE_NAME_PREFIX = "MyRobotController_"; // ESP32 側でこの接頭辞で名前を付ける想定

/* -------------------------
   UI elements
   ------------------------- */
const statusEl = document.getElementById('status');
const connectBtn = document.getElementById('connectBtn');
const reconnectBtn = document.getElementById('reconnectBtn');

const joy = document.getElementById('joystick');
const stick = document.getElementById('stick');
const leftBtn = document.getElementById('leftRotate');
const rightBtn = document.getElementById('rightRotate');

const sEls = [
  document.getElementById('s1'),
  document.getElementById('s2'),
  document.getElementById('s3'),
  document.getElementById('s4'),
];
const sVals = [
  document.getElementById('s1val'),
  document.getElementById('s2val'),
  document.getElementById('s3val'),
  document.getElementById('s4val'),
];

const motorSlider = document.getElementById('motorSlider');
const motorVal = document.getElementById('motorVal');

/* -------------------------
   BLE state
   ------------------------- */
let device = null;
let server = null;
let characteristic = null;
let connected = false;

/* -------------------------
   Joystick state
   ------------------------- */
const DEADZONE = 0.15;
let radius = 160; // will be updated by layout()
let stickR = 48;
let centerX = radius, centerY = radius;
let active = false;
let currentX = 0, currentY = 0;
let omega = 0;

/* -------------------------
   Helpers
   ------------------------- */
function applyDeadzone(v) {
  const dz = DEADZONE;
  if (Math.abs(v) < dz) return 0;
  return v > 0 ? (v - dz)/(1 - dz) : (v + dz)/(1 - dz);
}

function debounce(fn, wait) {
  let t;
  return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); };
}

/* -------------------------
   BLE: connect / disconnect
   ------------------------- */
async function connectBLE() {
  if (connected) return;
  try {
    statusEl.textContent = "接続要求中...";
    device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: DEVICE_NAME_PREFIX }],
      optionalServices: [SERVICE_UUID]
    });

    statusEl.textContent = `接続中: ${device.name}`;
    device.addEventListener('gattserverdisconnected', onDisconnected);

    server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
    connected = true;
    statusEl.textContent = `✅ 接続完了: ${device.name}`;
    connectBtn.textContent = "切断";
    // on connect, send neutral state so robot is safe
    sendCurrentState();
  } catch (err) {
    console.error('connectBLE error', err);
    statusEl.textContent = `❌ 接続失敗`;
    connected = false;
    characteristic = null;
  }
}

function disconnectBLE() {
  if (!device) return;
  try {
    device.gatt.disconnect();
  } catch (e) {}
  connected = false;
  characteristic = null;
  statusEl.textContent = '切断済み';
  connectBtn.textContent = '接続';
}

function onDisconnected() {
  connected = false;
  characteristic = null;
  statusEl.textContent = '⚠️ 切断されました';
  connectBtn.textContent = '接続';
}

/* -------------------------
   send data format (text CSV)
   vx,vy,w,m4,s1,s2,s3,s4
   ------------------------- */
async function sendBLEData(vx, vy, w, m4, s1, s2, s3, s4) {
  if (!connected || !characteristic) return;
  const msg = `${vx},${vy},${w},${m4},${s1},${s2},${s3},${s4}`;
  try {
    const enc = new TextEncoder();
    await characteristic.writeValue(enc.encode(msg));
    statusEl.textContent = `送信: vx=${vx}, vy=${vy}, ω=${w}  m4=${m4}  s:[${s1},${s2},${s3},${s4}]`;
  } catch (e) {
    console.warn('writeValue failed', e);
    statusEl.textContent = "⚠️ 送信エラー: 再接続を試みます";
    // leave characteristic null; user can press 再接続 or 接続 again
  }
}

/* convenience that reads current sliders and sends */
function sendCurrentState() {
  const s1 = parseInt(sEls[0].value);
  const s2 = parseInt(sEls[1].value);
  const s3 = parseInt(sEls[2].value);
  const s4 = parseInt(sEls[3].value);
  const m4 = parseFloat(motorSlider.value).toFixed(2); // -1.00..1.00
  // vx,vy rounded to 2 decimals, omega integer -1/0/1
  sendBLEData(currentX.toFixed(2), currentY.toFixed(2), omega, m4, s1, s2, s3, s4);
}

/* -------------------------
   UI wiring
   ------------------------- */
connectBtn.addEventListener('click', async () => {
  if (connected) { disconnectBLE(); return; }
  await connectBLE();
});

// reconnect button tries to re-open (not aggressive)
reconnectBtn.addEventListener('click', async () => {
  if (!device) { statusEl.textContent = 'デバイス未選択 - 接続からやり直してください'; return; }
  statusEl.textContent = '再接続試行...';
  try {
    server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
    connected = true;
    statusEl.textContent = `🔄 再接続成功: ${device.name}`;
    connectBtn.textContent = '切断';
    sendCurrentState();
  } catch (e) {
    console.warn('reconnect failed', e);
    statusEl.textContent = '再接続失敗';
  }
});

/* slider handling: show values and debounce sends */
for (let i = 0; i < sEls.length; i++) {
  const el = sEls[i];
  const disp = sVals[i];
  const sendAfter = debounce(() => sendCurrentState(), 60);
  el.addEventListener('input', () => {
    disp.textContent = el.value;
    sendAfter();
  });
  // ensure slider touches don't move joystick
  el.addEventListener('pointerdown', (e) => e.stopPropagation());
}

// motor slider: show value and debounce send (same UX as servos)
const motorSendAfter = debounce(() => sendCurrentState(), 60);
motorSlider.addEventListener('input', () => {
  const v = parseFloat(motorSlider.value).toFixed(2);
  motorVal.textContent = v;
  motorSendAfter();
});
motorSlider.addEventListener('pointerdown', (e) => e.stopPropagation());

/* rotation buttons: pointer events for touch */
function pressStart(btn, val) {
  omega = val;
  btn.classList.add('pressed');
  sendCurrentState();
}
function pressEnd(btn) {
  omega = 0;
  btn.classList.remove('pressed');
  sendCurrentState();
}
leftBtn.addEventListener('pointerdown', (e) => { e.preventDefault(); pressStart(leftBtn, -1); });
rightBtn.addEventListener('pointerdown', (e) => { e.preventDefault(); pressStart(rightBtn, 1); });
['pointerup','pointercancel','touchend','touchcancel','mouseleave'].forEach(ev => {
  leftBtn.addEventListener(ev, () => pressEnd(leftBtn));
  rightBtn.addEventListener(ev, () => pressEnd(rightBtn));
});

/* joystick events */
function layout() {
  const rect = joy.getBoundingClientRect();
  radius = rect.width / 2;
  // choose stickR proportional to size
  stickR = Math.max(36, rect.width * 0.12);
  centerX = rect.width / 2;
  centerY = rect.height / 2;
  // place stick center
  stick.style.left = centerX + 'px';
  stick.style.top = centerY + 'px';
}
window.addEventListener('load', layout);
window.addEventListener('resize', layout);

joy.addEventListener('pointerdown', (e) => {
  active = true;
  try { joy.setPointerCapture(e.pointerId); } catch (e) {}
  moveStick(e);
});
joy.addEventListener('pointermove', (e) => { if (active) moveStick(e); });
joy.addEventListener('pointerup', (e) => { active = false; try { joy.releasePointerCapture(e.pointerId); } catch(e){}; resetStick(); });
joy.addEventListener('pointerleave', (e) => { if (active) { active = false; resetStick(); } });

const throttledSend = debounce(() => sendCurrentState(), 40);

function moveStick(e) {
  const rect = joy.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  let dx = x - centerX;
  let dy = y - centerY;
  const maxDist = Math.max(1, radius - stickR - 4);
  const dist = Math.min(Math.hypot(dx, dy), maxDist);
  const angle = Math.atan2(dy, dx);
  const posX = Math.cos(angle) * dist;
  const posY = Math.sin(angle) * dist;
  stick.style.left = (centerX + posX) + 'px';
  stick.style.top = (centerY + posY) + 'px';

  const rawX = posX / (radius - stickR);
  const rawY = -posY / (radius - stickR); // up is positive
  currentX = applyDeadzone(rawX);
  currentY = applyDeadzone(rawY);
  throttledSend();
}

function resetStick() {
  stick.style.left = centerX + 'px';
  stick.style.top = centerY + 'px';
  currentX = 0; currentY = 0;
  sendCurrentState();
}

/* initial neutral send after short delay */
setTimeout(() => {
  // ensure initial slider text matches values
  for (let i = 0; i < sEls.length; i++) sVals[i].textContent = sEls[i].value;
  motorVal.textContent = parseFloat(motorSlider.value).toFixed(2);
  sendCurrentState();
}, 400);

/* keyboard support (for desktop testing) */
window.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft') { currentX = -1; sendCurrentState(); }
  if (e.key === 'ArrowRight') { currentX = 1; sendCurrentState(); }
  if (e.key === 'ArrowUp') { currentY = 1; sendCurrentState(); }
  if (e.key === 'ArrowDown') { currentY = -1; sendCurrentState(); }
});

/* small safety: catch page visibility change to optionally pause sends (no-op for now) */
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // optionally send neutral to be safe
    // sendBLEData(0,0,0, ...current servos...);
  }
});
</script>
</body>
</html>
